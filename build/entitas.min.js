/*
 MIT license
 @link http://stackoverflow.com/questions/105034/how-to-create-a-guid-uuid-in-javascript/21963136#21963136
*/
var entitas;
(function(entitas){var utils;(function(utils){var hex=["00","01","02","03","04","05","06","07","08","09","0a","0b","0c","0d","0e","0f","10","11","12","13","14","15","16","17","18","19","1a","1b","1c","1d","1e","1f","20","21","22","23","24","25","26","27","28","29","2a","2b","2c","2d","2e","2f","30","31","32","33","34","35","36","37","38","39","3a","3b","3c","3d","3e","3f","40","41","42","43","44","45","46","47","48","49","4a","4b","4c","4d","4e","4f","50","51","52","53","54","55","56","57","58","59",
"5a","5b","5c","5d","5e","5f","60","61","62","63","64","65","66","67","68","69","6a","6b","6c","6d","6e","6f","70","71","72","73","74","75","76","77","78","79","7a","7b","7c","7d","7e","7f","80","81","82","83","84","85","86","87","88","89","8a","8b","8c","8d","8e","8f","90","91","92","93","94","95","96","97","98","99","9a","9b","9c","9d","9e","9f","a0","a1","a2","a3","a4","a5","a6","a7","a8","a9","aa","ab","ac","ad","ae","af","b0","b1","b2","b3","b4","b5","b6","b7","b8","b9","ba","bb","bc","bd","be",
"bf","c0","c1","c2","c3","c4","c5","c6","c7","c8","c9","ca","cb","cc","cd","ce","cf","d0","d1","d2","d3","d4","d5","d6","d7","d8","d9","da","db","dc","dd","de","df","e0","e1","e2","e3","e4","e5","e6","e7","e8","e9","ea","eb","ec","ed","ee","ef","f0","f1","f2","f3","f4","f5","f6","f7","f8","f9","fa","fb","fc","fd","fe","ff"];var UUID=function(){function UUID(){}UUID.randomUUID=function(){var d0=Math.random()*4294967295|0;var d1=Math.random()*4294967295|0;var d2=Math.random()*4294967295|0;var d3=Math.random()*
4294967295|0;return hex[d0&255]+hex[d0>>8&255]+hex[d0>>16&255]+hex[d0>>24&255]+"-"+hex[d1&255]+hex[d1>>8&255]+"-"+hex[d1>>16&15|64]+hex[d1>>24&255]+"-"+hex[d2&63|128]+hex[d2>>8&255]+"-"+hex[d2>>16&255]+hex[d2>>24&255]+hex[d3&255]+hex[d3>>8&255]+hex[d3>>16&255]+hex[d3>>24&255]};return UUID}();utils.UUID=UUID})(utils=entitas.utils||(entitas.utils={}))})(entitas||(entitas={}));
var __extends=this&&this.__extends||function(d,b){for(var p in b)if(b.hasOwnProperty(p))d[p]=b[p];function __(){this.constructor=d}d.prototype=b===null?Object.create(b):(__.prototype=b.prototype,new __)};var entitas;
(function(entitas){var utils;(function(utils){var Bag=function(_super){__extends(Bag,_super);function Bag(capacity){if(capacity===void 0)capacity=64;_super.call(this);this.size_=0;this.length=capacity}Bag.prototype.removeAt=function(index){var e=this[index];this[index]=this[--this.size_];this[this.size_]=null;return e};Bag.prototype.remove=function(e){var i;var e2;var size=this.size_;for(i=0;i<size;i++){e2=this[i];if(e==e2){this[i]=this[--this.size_];this[this.size_]=null;return true}}return false};
Bag.prototype.removeLast=function(){if(this.size_>0){var e=this[--this.size_];this[this.size_]=null;return e}return null};Bag.prototype.contains=function(e){var i;var size;for(i=0,size=this.size_;size>i;i++)if(e===this[i])return true;return false};Bag.prototype.removeAll=function(bag){var modified=false;var i;var j;var l;var e1;var e2;for(i=0,l=bag.size();i<l;i++){e1=bag.get(i);for(j=0;j<this.size_;j++){e2=this[j];if(e1===e2){this.removeAt(j);j--;modified=true;break}}}return modified};Bag.prototype.get=
function(index){if(index>=this.length)throw new Error("ArrayIndexOutOfBoundsException");return this[index]};Bag.prototype.safeGet=function(index){if(index>=this.length)this.grow(index*7/4+1);return this[index]};Bag.prototype.size=function(){return this.size_};Bag.prototype.getCapacity=function(){return this.length};Bag.prototype.isIndexWithinBounds=function(index){return index<this.getCapacity()};Bag.prototype.isEmpty=function(){return this.size_==0};Bag.prototype.add=function(e){if(this.size_===
this.length)this.grow();this[this.size_++]=e};Bag.prototype.set=function(index,e){if(index>=this.length)this.grow(index*2);this.size_=index+1;this[index]=e};Bag.prototype.grow=function(newCapacity){if(newCapacity===void 0)newCapacity=~~(this.length*3/2)+1;this.length=~~newCapacity};Bag.prototype.ensureCapacity=function(index){if(index>=this.length)this.grow(index*2)};Bag.prototype.clear=function(){var i;var size;for(i=0,size=this.size_;i<size;i++)this[i]=null;this.size_=0};Bag.prototype.addAll=function(items){var i;
for(i=0;items.size()>i;i++)this.add(items.get(i))};return Bag}(Array);utils.Bag=Bag})(utils=entitas.utils||(entitas.utils={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var utils;(function(utils){var Bag=entitas.utils.Bag;var Signal=function(){function Signal(context,alloc){if(alloc===void 0)alloc=16;this._listeners=new Bag;this._context=context;this._alloc=alloc;this.active=false}Signal.prototype.dispatch=function($0,$1,$2,$3,$4){var listeners=this._listeners;var size=listeners.size();if(size<=0)return;var context=this._context;for(var i=0;i<size;i++)listeners[i].call(context,$0,$1,$2,$3,$4)};Signal.prototype.add=function(listener){this._listeners.add(listener);
this.active=true};Signal.prototype.remove=function(listener){var listeners=this._listeners;listeners.remove(listener);this.active=listeners.size()>0};Signal.prototype.clear=function(){this._listeners.clear();this.active=false};return Signal}();utils.Signal=Signal})(utils=entitas.utils||(entitas.utils={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var utils;(function(utils){var Stopwatch=function(){function Stopwatch(){Stopwatch.isHighRes=performance?true:false;this.reset()}Object.defineProperty(Stopwatch.prototype,"isRunning",{get:function(){return this._isRunning},enumerable:true,configurable:true});Object.defineProperty(Stopwatch.prototype,"startTimeStamp",{get:function(){return this._startTimeStamp},enumerable:true,configurable:true});Object.defineProperty(Stopwatch.prototype,"elapsed",{get:function(){return this._elapsed},
enumerable:true,configurable:true});Stopwatch.prototype.start=function(){if(!this._isRunning){this._startTimeStamp=Stopwatch.getTimeStamp();this._isRunning=true}};Stopwatch.prototype.stop=function(){if(this._isRunning){this._elapsed+=Stopwatch.getTimeStamp()-this._startTimeStamp;this._isRunning=false}};Stopwatch.prototype.reset=function(){this._elapsed=0;this._startTimeStamp=0;this._isRunning=false};Stopwatch.getTimeStamp=function(){return Stopwatch.isHighRes?performance.now():Date.now()};Stopwatch.isHighRes=
false;return Stopwatch}();utils.Stopwatch=Stopwatch})(utils=entitas.utils||(entitas.utils={}))})(entitas||(entitas={}));var entitas;(function(entitas){var Exception=function(){function Exception(message){this.message=message}Exception.prototype.toString=function(){return this.message};return Exception}();entitas.Exception=Exception})(entitas||(entitas={}));var entitas;
(function(entitas){var exceptions;(function(exceptions){var Exception=entitas.Exception;var EntityAlreadyHasComponentException=function(_super){__extends(EntityAlreadyHasComponentException,_super);function EntityAlreadyHasComponentException(message,index){_super.call(this,message+"\nEntity already has a component at index "+index)}return EntityAlreadyHasComponentException}(Exception);exceptions.EntityAlreadyHasComponentException=EntityAlreadyHasComponentException})(exceptions=entitas.exceptions||
(entitas.exceptions={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var exceptions;(function(exceptions){var Exception=entitas.Exception;var EntityDoesNotHaveComponentException=function(_super){__extends(EntityDoesNotHaveComponentException,_super);function EntityDoesNotHaveComponentException(message,index){_super.call(this,message+"\nEntity does not have a component at index "+index)}return EntityDoesNotHaveComponentException}(Exception);exceptions.EntityDoesNotHaveComponentException=EntityDoesNotHaveComponentException})(exceptions=entitas.exceptions||
(entitas.exceptions={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var exceptions;(function(exceptions){var Exception=entitas.Exception;var EntityIsNotEnabledException=function(_super){__extends(EntityIsNotEnabledException,_super);function EntityIsNotEnabledException(message){_super.call(this,message+"\nEntity is not enabled")}return EntityIsNotEnabledException}(Exception);exceptions.EntityIsNotEnabledException=EntityIsNotEnabledException})(exceptions=entitas.exceptions||(entitas.exceptions={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var exceptions;(function(exceptions){var Exception=entitas.Exception;var EntityIsAlreadyReleasedException=function(_super){__extends(EntityIsAlreadyReleasedException,_super);function EntityIsAlreadyReleasedException(){_super.call(this,"Entity is already released!")}return EntityIsAlreadyReleasedException}(Exception);exceptions.EntityIsAlreadyReleasedException=EntityIsAlreadyReleasedException})(exceptions=entitas.exceptions||(entitas.exceptions={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var exceptions;(function(exceptions){var Exception=entitas.Exception;var SingleEntityException=function(_super){__extends(SingleEntityException,_super);function SingleEntityException(matcher){_super.call(this,"Multiple entities exist matching "+matcher)}return SingleEntityException}(Exception);exceptions.SingleEntityException=SingleEntityException})(exceptions=entitas.exceptions||(entitas.exceptions={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var exceptions;(function(exceptions){var Exception=entitas.Exception;var GroupObserverException=function(_super){__extends(GroupObserverException,_super);function GroupObserverException(message){_super.call(this,message)}return GroupObserverException}(Exception);exceptions.GroupObserverException=GroupObserverException})(exceptions=entitas.exceptions||(entitas.exceptions={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var exceptions;(function(exceptions){var Exception=entitas.Exception;var PoolDoesNotContainEntityException=function(_super){__extends(PoolDoesNotContainEntityException,_super);function PoolDoesNotContainEntityException(entity,message){_super.call(this,message+"\nPool does not contain entity "+entity)}return PoolDoesNotContainEntityException}(Exception);exceptions.PoolDoesNotContainEntityException=PoolDoesNotContainEntityException})(exceptions=entitas.exceptions||(entitas.exceptions=
{}))})(entitas||(entitas={}));var entitas;
(function(entitas){var exceptions;(function(exceptions){var Exception=entitas.Exception;var EntityIsNotDestroyedException=function(_super){__extends(EntityIsNotDestroyedException,_super);function EntityIsNotDestroyedException(message){_super.call(this,message+"\nEntity is not destroyed yet!")}return EntityIsNotDestroyedException}(Exception);exceptions.EntityIsNotDestroyedException=EntityIsNotDestroyedException})(exceptions=entitas.exceptions||(entitas.exceptions={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var exceptions;(function(exceptions){var Exception=entitas.Exception;var MatcherException=function(_super){__extends(MatcherException,_super);function MatcherException(matcher){_super.call(this,"matcher.indices.length must be 1 but was "+matcher.indices.length)}return MatcherException}(Exception);exceptions.MatcherException=MatcherException})(exceptions=entitas.exceptions||(entitas.exceptions={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var MatcherException=entitas.exceptions.MatcherException;var GroupEventType=entitas.GroupEventType;var TriggerOnEvent=entitas.TriggerOnEvent;var Matcher=function(){function Matcher(){this._id=Matcher.uniqueId++}Object.defineProperty(Matcher.prototype,"id",{get:function(){return this._id},enumerable:true,configurable:true});Object.defineProperty(Matcher.prototype,"indices",{get:function(){if(!this._indices)this._indices=this.mergeIndices();return this._indices},enumerable:true,configurable:true});
Object.defineProperty(Matcher.prototype,"allOfIndices",{get:function(){return this._allOfIndices},enumerable:true,configurable:true});Object.defineProperty(Matcher.prototype,"anyOfIndices",{get:function(){return this._anyOfIndices},enumerable:true,configurable:true});Object.defineProperty(Matcher.prototype,"noneOfIndices",{get:function(){return this._noneOfIndices},enumerable:true,configurable:true});Matcher.prototype.anyOf=function(){var args=[];for(var _i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];
if("number"===typeof args[0]||"string"===typeof args[0]){this._anyOfIndices=Matcher.distinctIndices(args);this._indices=null;return this}else return this.anyOf.apply(this,Matcher.mergeIndices(args))};Matcher.prototype.noneOf=function(){var args=[];for(var _i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if("number"===typeof args[0]||"string"===typeof args[0]){this._noneOfIndices=Matcher.distinctIndices(args);this._indices=null;return this}else return this.noneOf.apply(this,Matcher.mergeIndices(args))};
Matcher.prototype.matches=function(entity){var matchesAllOf=this._allOfIndices==null?true:entity.hasComponents(this._allOfIndices);var matchesAnyOf=this._anyOfIndices==null?true:entity.hasAnyComponent(this._anyOfIndices);var matchesNoneOf=this._noneOfIndices==null?true:!entity.hasAnyComponent(this._noneOfIndices);return matchesAllOf&&matchesAnyOf&&matchesNoneOf};Matcher.prototype.mergeIndices=function(){var indicesList=[];if(this._allOfIndices!=null)indicesList=indicesList.concat(this._allOfIndices);
if(this._anyOfIndices!=null)indicesList=indicesList.concat(this._anyOfIndices);if(this._noneOfIndices!=null)indicesList=indicesList.concat(this._noneOfIndices);return Matcher.distinctIndices(indicesList)};Matcher.prototype.toString=function(){if(this._toStringCache==null){var sb=[];if(this._allOfIndices!=null)Matcher.appendIndices(sb,"AllOf",this._allOfIndices);if(this._anyOfIndices!=null){if(this._allOfIndices!=null)sb[sb.length]=".";Matcher.appendIndices(sb,"AnyOf",this._anyOfIndices)}if(this._noneOfIndices!=
null)Matcher.appendIndices(sb,".NoneOf",this._noneOfIndices);this._toStringCache=sb.join("")}return this._toStringCache};Matcher.prototype.equals=function(obj){if(obj==null||obj==null)return false;var matcher=obj;if(!Matcher.equalIndices(matcher.allOfIndices,this._allOfIndices))return false;if(!Matcher.equalIndices(matcher.anyOfIndices,this._anyOfIndices))return false;if(!Matcher.equalIndices(matcher.noneOfIndices,this._noneOfIndices))return false;return true};Matcher.equalIndices=function(i1,i2){if(i1==
null!=(i2==null))return false;if(i1==null)return true;if(i1.length!==i2.length)return false;for(var i=0,indicesLength=i1.length;i<indicesLength;i++)if(i1[i]!=i2[i])return false;return true};Matcher.distinctIndices=function(indices){var indicesSet={};for(var i=0,l=indices.length;i<l;i++){var k=""+indices[i];indicesSet[k]=i}return[].concat(Object.keys(indicesSet))};Matcher.mergeIndices=function(matchers){var indices=[];for(var i=0,matchersLength=matchers.length;i<matchersLength;i++){var matcher=matchers[i];
if(matcher.indices.length!==1)throw new MatcherException(matcher);indices[i]=matcher.indices[0]}return indices};Matcher.allOf=function(){var args=[];for(var _i=0;_i<arguments.length;_i++)args[_i-0]=arguments[_i];if("number"===typeof args[0]||"string"===typeof args[0]){var matcher=new Matcher;var indices=matcher._allOfIndices=Matcher.distinctIndices(args);return matcher}else return Matcher.allOf.apply(this,Matcher.mergeIndices(args))};Matcher.anyOf=function(){var args=[];for(var _i=0;_i<arguments.length;_i++)args[_i-
0]=arguments[_i];if("number"===typeof args[0]||"string"===typeof args[0]){var matcher=new Matcher;var indices=matcher._anyOfIndices=Matcher.distinctIndices(args);return matcher}else return Matcher.anyOf.apply(this,Matcher.mergeIndices(args))};Matcher.appendIndices=function(sb,prefix,indexArray){var SEPERATOR=", ";var j=sb.length;sb[j++]=prefix;sb[j++]="(";var lastSeperator=indexArray.length-1;for(var i=0,indicesLength=indexArray.length;i<indicesLength;i++){sb[j++]=""+indexArray[i];if(i<lastSeperator)sb[j++]=
SEPERATOR}sb[j++]=")"};Matcher.prototype.onEntityAdded=function(){return new TriggerOnEvent(this,GroupEventType.OnEntityAdded)};Matcher.prototype.onEntityRemoved=function(){return new TriggerOnEvent(this,GroupEventType.OnEntityRemoved)};Matcher.prototype.onEntityAddedOrRemoved=function(){return new TriggerOnEvent(this,GroupEventType.OnEntityAddedOrRemoved)};Matcher.uniqueId=0;return Matcher}();entitas.Matcher=Matcher})(entitas||(entitas={}));var entitas;
(function(entitas){var TriggerOnEvent=function(){function TriggerOnEvent(trigger,eventType){this.trigger=trigger;this.eventType=eventType}return TriggerOnEvent}();entitas.TriggerOnEvent=TriggerOnEvent})(entitas||(entitas={}));var entitas;
(function(entitas){var Signal=entitas.utils.Signal;var EntityIsNotEnabledException=entitas.exceptions.EntityIsNotEnabledException;var EntityIsAlreadyReleasedException=entitas.exceptions.EntityIsAlreadyReleasedException;var EntityAlreadyHasComponentException=entitas.exceptions.EntityAlreadyHasComponentException;var EntityDoesNotHaveComponentException=entitas.exceptions.EntityDoesNotHaveComponentException;var Entity=function(){function Entity(componentsEnum,totalComponents){if(totalComponents===void 0)totalComponents=
16;this.onEntityReleased=null;this.onComponentAdded=null;this.onComponentRemoved=null;this.onComponentReplaced=null;this.name="";this.id="";this.instanceIndex=0;this._creationIndex=0;this._isEnabled=true;this._components=null;this._componentsCache=null;this._componentIndicesCache=null;this._toStringCache="";this._refCount=0;this._pool=null;this._componentsEnum=null;this.onEntityReleased=new Signal(this);this.onComponentAdded=new Signal(this);this.onComponentRemoved=new Signal(this);this.onComponentReplaced=
new Signal(this);this._componentsEnum=componentsEnum;this._pool=entitas.Pool.instance;this._components=this.initialize(totalComponents)}Object.defineProperty(Entity.prototype,"creationIndex",{get:function(){return this._creationIndex},enumerable:true,configurable:true});Entity.initialize=function(totalComponents,options){Entity.size=options.entities||100};Entity.dim=function(count,size){Entity.alloc=new Array(size);for(var e=0;e<size;e++){Entity.alloc[e]=new Array(count);for(var k=0;k<count;k++)Entity.alloc[e][k]=
null}};Entity.prototype.initialize=function(totalComponents){var mem;var size=Entity.size;if(Entity.alloc==null)Entity.dim(totalComponents,size);var alloc=Entity.alloc;this.instanceIndex=Entity.instanceIndex++;if(mem=alloc[this.instanceIndex])return mem;console.log("Insufficient memory allocation at ",this.instanceIndex,". Allocating ",size," entities.");for(var i=this.instanceIndex,l=i+size;i<l;i++){alloc[i]=new Array(totalComponents);for(var k=0;k<totalComponents;k++)alloc[i][k]=null}mem=alloc[this.instanceIndex];
return mem};Entity.prototype.addComponent=function(index,component){if(!this._isEnabled)throw new EntityIsNotEnabledException("Cannot add component!");if(this.hasComponent(index)){var errorMsg="Cannot add component at index "+index+" to "+this;throw new EntityAlreadyHasComponentException(errorMsg,index);}this._components[index]=component;this._componentsCache=null;this._componentIndicesCache=null;this._toStringCache=null;var onComponentAdded=this.onComponentAdded;if(onComponentAdded.active)onComponentAdded.dispatch(this,
index,component);return this};Entity.prototype.removeComponent=function(index){if(!this._isEnabled)throw new EntityIsNotEnabledException("Cannot remove component!");if(!this.hasComponent(index)){var errorMsg="Cannot remove component at index "+index+" from "+this;throw new EntityDoesNotHaveComponentException(errorMsg,index);}this._replaceComponent(index,null);return this};Entity.prototype.replaceComponent=function(index,component){if(!this._isEnabled)throw new EntityIsNotEnabledException("Cannot replace component!");
if(this.hasComponent(index))this._replaceComponent(index,component);else if(component!=null)this.addComponent(index,component);return this};Entity.prototype._replaceComponent=function(index,replacement){var components=this._components;var previousComponent=components[index];if(previousComponent===replacement){var onComponentReplaced=this.onComponentReplaced;if(onComponentReplaced.active)onComponentReplaced.dispatch(this,index,previousComponent,replacement)}else{components[index]=replacement;this._componentsCache=
null;if(replacement==null){delete components[index];this._componentIndicesCache=null;this._toStringCache=null;var onComponentRemoved=this.onComponentRemoved;if(onComponentRemoved.active)onComponentRemoved.dispatch(this,index,previousComponent)}else{var onComponentReplaced=this.onComponentReplaced;if(onComponentReplaced.active)onComponentReplaced.dispatch(this,index,previousComponent,replacement)}}};Entity.prototype.getComponent=function(index){if(!this.hasComponent(index)){var errorMsg="Cannot get component at index "+
index+" from "+this;throw new EntityDoesNotHaveComponentException(errorMsg,index);}return this._components[index]};Entity.prototype.getComponents=function(){if(this._componentsCache==null){var components=[];var _components=this._components;for(var i=0,j=0,componentsLength=_components.length;i<componentsLength;i++){var component=_components[i];if(component!=null)components[j++]=component}this._componentsCache=components}return this._componentsCache};Entity.prototype.getComponentIndices=function(){if(this._componentIndicesCache==
null){var indices=[];var _components=this._components;for(var i=0,j=0,componentsLength=_components.length;i<componentsLength;i++)if(_components[i]!=null)indices[j++]=i;this._componentIndicesCache=indices}return this._componentIndicesCache};Entity.prototype.hasComponent=function(index){return this._components[index]!=null};Entity.prototype.hasComponents=function(indices){var _components=this._components;for(var i=0,indicesLength=indices.length;i<indicesLength;i++)if(_components[indices[i]]==null)return false;
return true};Entity.prototype.hasAnyComponent=function(indices){var _components=this._components;for(var i=0,indicesLength=indices.length;i<indicesLength;i++)if(_components[indices[i]]!=null)return true;return false};Entity.prototype.removeAllComponents=function(){this._toStringCache=null;var _components=this._components;for(var i=0,componentsLength=_components.length;i<componentsLength;i++)if(_components[i]!=null)this._replaceComponent(i,null)};Entity.prototype.destroy=function(){this.removeAllComponents();
this.onComponentAdded.clear();this.onComponentReplaced.clear();this.onComponentRemoved.clear();this._isEnabled=false};Entity.prototype.toString=function(){if(this._toStringCache==null){var sb=[];var seperator=", ";var components=this.getComponents();var lastSeperator=components.length-1;for(var i=0,j=0,componentsLength=components.length;i<componentsLength;i++){sb[j++]=components[i].constructor["name"].replace("Component","")||i+"";if(i<lastSeperator)sb[j++]=seperator}this._toStringCache=sb.join("")}return this._toStringCache};
Entity.prototype.addRef=function(){this._refCount+=1;return this};Entity.prototype.release=function(){this._refCount-=1;if(this._refCount===0){var onEntityReleased=this.onEntityReleased;if(onEntityReleased.active)onEntityReleased.dispatch(this)}else if(this._refCount<0)throw new EntityIsAlreadyReleasedException;};Entity.instanceIndex=0;Entity.alloc=null;Entity.size=0;return Entity}();entitas.Entity=Entity})(entitas||(entitas={}));var entitas;
(function(entitas){var Signal=entitas.utils.Signal;var GroupEventType=entitas.GroupEventType;var SingleEntityException=entitas.exceptions.SingleEntityException;var Group=function(){function Group(matcher){this.onEntityAdded=null;this.onEntityRemoved=null;this.onEntityUpdated=null;this._entities={};this._matcher=null;this._entitiesCache=null;this._singleEntityCache=null;this._toStringCache="";this._entities={};this.onEntityAdded=new Signal(this);this.onEntityRemoved=new Signal(this);this.onEntityUpdated=
new Signal(this);this._matcher=matcher}Object.defineProperty(Group.prototype,"count",{get:function(){return Object.keys(this._entities).length},enumerable:true,configurable:true});Object.defineProperty(Group.prototype,"matcher",{get:function(){return this._matcher},enumerable:true,configurable:true});Group.prototype.createObserver=function(eventType){if(eventType===undefined)eventType=GroupEventType.OnEntityAdded;return new entitas.GroupObserver(this,eventType)};Group.prototype.handleEntitySilently=
function(entity){if(this._matcher.matches(entity))this.addEntitySilently(entity);else this.removeEntitySilently(entity)};Group.prototype.handleEntity=function(entity,index,component){if(this._matcher.matches(entity))this.addEntity(entity,index,component);else this.removeEntity(entity,index,component)};Group.prototype.updateEntity=function(entity,index,previousComponent,newComponent){if(entity.id in this._entities){var onEntityRemoved=this.onEntityRemoved;if(onEntityRemoved.active)onEntityRemoved.dispatch(this,
entity,index,previousComponent);var onEntityAdded=this.onEntityAdded;if(onEntityAdded.active)onEntityAdded.dispatch(this,entity,index,newComponent);var onEntityUpdated=this.onEntityUpdated;if(onEntityUpdated.active)onEntityUpdated.dispatch(this,entity,index,previousComponent,newComponent)}};Group.prototype.addEntitySilently=function(entity){if(!(entity.id in this._entities)){this._entities[entity.id]=entity;this._entitiesCache=null;this._singleEntityCache=null;entity.addRef()}};Group.prototype.addEntity=
function(entity,index,component){if(!(entity.id in this._entities)){this._entities[entity.id]=entity;this._entitiesCache=null;this._singleEntityCache=null;entity.addRef();var onEntityAdded=this.onEntityAdded;if(onEntityAdded.active)onEntityAdded.dispatch(this,entity,index,component)}};Group.prototype.removeEntitySilently=function(entity){if(entity.id in this._entities){delete this._entities[entity.id];this._entitiesCache=null;this._singleEntityCache=null;entity.release()}};Group.prototype.removeEntity=
function(entity,index,component){if(entity.id in this._entities){delete this._entities[entity.id];this._entitiesCache=null;this._singleEntityCache=null;var onEntityRemoved=this.onEntityRemoved;if(onEntityRemoved.active)onEntityRemoved.dispatch(this,entity,index,component);entity.release()}};Group.prototype.containsEntity=function(entity){return entity.id in this._entities};Group.prototype.getEntities=function(){if(this._entitiesCache==null){var entities=this._entities;var keys=Object.keys(entities);
var length=keys.length;var entitiesCache=this._entitiesCache=new Array(length);for(var i=0;i<length;i++)entitiesCache[i]=entities[keys[i]]}return this._entitiesCache};Group.prototype.getSingleEntity=function(){if(this._singleEntityCache==null){var enumerator=Object.keys(this._entities);var c=enumerator.length;if(c===1)this._singleEntityCache=this._entities[enumerator[0]];else if(c===0)return null;else throw new SingleEntityException(this._matcher);}return this._singleEntityCache};Group.prototype.toString=
function(){if(this._toStringCache==null)this._toStringCache="Group("+this._matcher+")";return this._toStringCache};return Group}();entitas.Group=Group})(entitas||(entitas={}));var entitas;
(function(entitas){var GroupObserverException=entitas.exceptions.GroupObserverException;(function(GroupEventType){GroupEventType[GroupEventType["OnEntityAdded"]=0]="OnEntityAdded";GroupEventType[GroupEventType["OnEntityRemoved"]=1]="OnEntityRemoved";GroupEventType[GroupEventType["OnEntityAddedOrRemoved"]=2]="OnEntityAddedOrRemoved"})(entitas.GroupEventType||(entitas.GroupEventType={}));var GroupEventType=entitas.GroupEventType;var GroupObserver=function(){function GroupObserver(groups,eventTypes){var _this=
this;this._collectedEntities={};this._groups=null;this._eventTypes=null;this._addEntityCache=null;this.addEntity=function(group,entity,index,component){if(!(entity.id in _this._collectedEntities)){_this._collectedEntities[entity.id]=entity;entity.addRef()}};this._groups=Array.isArray(groups)?groups:[groups];this._eventTypes=Array.isArray(eventTypes)?eventTypes:[eventTypes];if(groups.length!==eventTypes.length)throw new GroupObserverException("Unbalanced count with groups ("+groups.length+") and event types ("+
eventTypes.length+")");this._collectedEntities={};this._addEntityCache=this.addEntity;this.activate()}Object.defineProperty(GroupObserver.prototype,"collectedEntities",{get:function(){return this._collectedEntities},enumerable:true,configurable:true});GroupObserver.prototype.activate=function(){for(var i=0,groupsLength=this._groups.length;i<groupsLength;i++){var group=this._groups[i];var eventType=this._eventTypes[i];if(eventType===GroupEventType.OnEntityAdded){group.onEntityAdded.remove(this._addEntityCache);
group.onEntityAdded.add(this._addEntityCache)}else if(eventType===GroupEventType.OnEntityRemoved){group.onEntityRemoved.remove(this._addEntityCache);group.onEntityRemoved.add(this._addEntityCache)}else if(eventType===GroupEventType.OnEntityAddedOrRemoved){group.onEntityAdded.remove(this._addEntityCache);group.onEntityAdded.add(this._addEntityCache);group.onEntityRemoved.remove(this._addEntityCache);group.onEntityRemoved.add(this._addEntityCache)}else throw"Invalid eventType ["+typeof eventType+":"+
eventType+"] in GroupObserver::activate";}};GroupObserver.prototype.deactivate=function(){var e;for(var i=0,groupsLength=this._groups.length;i<groupsLength;i++){var group=this._groups[i];group.onEntityAdded.remove(this._addEntityCache);group.onEntityRemoved.remove(this._addEntityCache);this.clearCollectedEntities()}};GroupObserver.prototype.clearCollectedEntities=function(){for(var e in this._collectedEntities)this._collectedEntities[e].release();this._collectedEntities={}};return GroupObserver}();
entitas.GroupObserver=GroupObserver})(entitas||(entitas={}));var entitas;
(function(entitas){var UUID=entitas.utils.UUID;var Bag=entitas.utils.Bag;var Group=entitas.Group;var Entity=entitas.Entity;var Signal=entitas.utils.Signal;var EntityIsNotDestroyedException=entitas.exceptions.EntityIsNotDestroyedException;var PoolDoesNotContainEntityException=entitas.exceptions.PoolDoesNotContainEntityException;function as(obj,method1){return method1 in obj?obj:null}var Pool=function(){function Pool(components,totalComponents,startCreationIndex){var _this=this;if(startCreationIndex===
void 0)startCreationIndex=0;this.onEntityCreated=null;this.onEntityWillBeDestroyed=null;this.onEntityDestroyed=null;this.onGroupCreated=null;this.name="";this._entities={};this._groups={};this._groupsForIndex=null;this._reusableEntities=new Bag;this._retainedEntities={};this._componentsEnum=null;this._totalComponents=0;this._creationIndex=0;this._entitiesCache=null;this.updateGroupsComponentAddedOrRemoved=function(entity,index,component){var groups=_this._groupsForIndex[index];if(groups!=null)for(var i=
0,groupsCount=groups.size();i<groupsCount;i++)groups[i].handleEntity(entity,index,component)};this.updateGroupsComponentReplaced=function(entity,index,previousComponent,newComponent){var groups=_this._groupsForIndex[index];if(groups!=null)for(var i=0,groupsCount=groups.size();i<groupsCount;i++)groups[i].updateEntity(entity,index,previousComponent,newComponent)};this.onEntityReleased=function(entity){if(entity._isEnabled)throw new EntityIsNotDestroyedException("Cannot release entity.");entity.onEntityReleased.remove(_this._cachedOnEntityReleased);
delete _this._retainedEntities[entity.id];_this._reusableEntities.add(entity)};Pool.instance=this;this.onGroupCreated=new Signal(this);this.onEntityCreated=new Signal(this);this.onEntityDestroyed=new Signal(this);this.onEntityWillBeDestroyed=new Signal(this);this._componentsEnum=components;this._totalComponents=totalComponents;this._creationIndex=startCreationIndex;this._groupsForIndex=new Bag;this._cachedUpdateGroupsComponentAddedOrRemoved=this.updateGroupsComponentAddedOrRemoved;this._cachedUpdateGroupsComponentReplaced=
this.updateGroupsComponentReplaced;this._cachedOnEntityReleased=this.onEntityReleased;Pool.componentsEnum=components;Pool.totalComponents=totalComponents}Object.defineProperty(Pool.prototype,"totalComponents",{get:function(){return this._totalComponents},enumerable:true,configurable:true});Object.defineProperty(Pool.prototype,"count",{get:function(){return Object.keys(this._entities).length},enumerable:true,configurable:true});Object.defineProperty(Pool.prototype,"reusableEntitiesCount",{get:function(){return this._reusableEntities.size()},
enumerable:true,configurable:true});Object.defineProperty(Pool.prototype,"retainedEntitiesCount",{get:function(){return Object.keys(this._retainedEntities).length},enumerable:true,configurable:true});Pool.setPool=function(system,pool){var poolSystem=as(system,"setPool");if(poolSystem!=null)poolSystem.setPool(pool)};Pool.prototype.createEntity=function(name){var entity=this._reusableEntities.size()>0?this._reusableEntities.removeLast():new Entity(this._componentsEnum,this._totalComponents);entity._isEnabled=
true;entity.name=name;entity._creationIndex=this._creationIndex++;entity.id=UUID.randomUUID();entity.addRef();this._entities[entity.id]=entity;this._entitiesCache=null;entity.onComponentAdded.add(this._cachedUpdateGroupsComponentAddedOrRemoved);entity.onComponentRemoved.add(this._cachedUpdateGroupsComponentAddedOrRemoved);entity.onComponentReplaced.add(this._cachedUpdateGroupsComponentReplaced);entity.onEntityReleased.add(this._cachedOnEntityReleased);var onEntityCreated=this.onEntityCreated;if(onEntityCreated.active)onEntityCreated.dispatch(this,
entity);return entity};Pool.prototype.destroyEntity=function(entity){if(!(entity.id in this._entities))throw new PoolDoesNotContainEntityException(entity,"Could not destroy entity!");delete this._entities[entity.id];this._entitiesCache=null;var onEntityWillBeDestroyed=this.onEntityWillBeDestroyed;if(onEntityWillBeDestroyed.active)onEntityWillBeDestroyed.dispatch(this,entity);entity.destroy();var onEntityDestroyed=this.onEntityDestroyed;if(onEntityDestroyed.active)onEntityDestroyed.dispatch(this,entity);
if(entity._refCount===1){entity.onEntityReleased.remove(this._cachedOnEntityReleased);this._reusableEntities.add(entity)}else this._retainedEntities[entity.id]=entity;entity.release()};Pool.prototype.destroyAllEntities=function(){var entities=this.getEntities();for(var i=0,entitiesLength=entities.length;i<entitiesLength;i++)this.destroyEntity(entities[i])};Pool.prototype.hasEntity=function(entity){return entity.id in this._entities};Pool.prototype.getEntities=function(matcher){if(matcher)return this.getGroup(matcher).getEntities();
else{if(this._entitiesCache==null){var entities=this._entities;var keys=Object.keys(entities);var length=keys.length;var entitiesCache=this._entitiesCache=new Array(length);for(var i=0;i<length;i++)entitiesCache[i]=entities[keys[i]]}return this._entitiesCache}};Pool.prototype.createSystem=function(system){if("function"===typeof system){var Klass=system;system=new Klass}Pool.setPool(system,this);var reactiveSystem=as(system,"trigger");if(reactiveSystem!=null)return new entitas.ReactiveSystem(this,
reactiveSystem);var multiReactiveSystem=as(system,"triggers");if(multiReactiveSystem!=null)return new entitas.ReactiveSystem(this,multiReactiveSystem);return system};Pool.prototype.getGroup=function(matcher){var group;if(matcher.id in this._groups)group=this._groups[matcher.id];else{group=new Group(matcher);var entities=this.getEntities();for(var i=0,entitiesLength=entities.length;i<entitiesLength;i++)group.handleEntitySilently(entities[i]);this._groups[matcher.id]=group;for(var i=0,indicesLength=
matcher.indices.length;i<indicesLength;i++){var index=matcher.indices[i];if(this._groupsForIndex[index]==null)this._groupsForIndex[index]=new Bag;this._groupsForIndex[index].add(group)}var onGroupCreated=this.onGroupCreated;if(onGroupCreated.active)onGroupCreated.dispatch(this,group)}return group};Pool.componentsEnum=null;Pool.totalComponents=0;Pool.instance=null;return Pool}();entitas.Pool=Pool})(entitas||(entitas={}));var entitas;
(function(entitas){var GroupObserver=entitas.GroupObserver;function as(object,method){return method in object?object:null}var ReactiveSystem=function(){function ReactiveSystem(pool,subSystem){var triggers="triggers"in subSystem?subSystem["triggers"]:[subSystem["trigger"]];this._subsystem=subSystem;var ensureComponents=as(subSystem,"ensureComponents");if(ensureComponents!=null)this._ensureComponents=ensureComponents.ensureComponents;var excludeComponents=as(subSystem,"excludeComponents");if(excludeComponents!=
null)this._excludeComponents=excludeComponents.excludeComponents;this._clearAfterExecute=as(subSystem,"clearAfterExecute")!=null;var triggersLength=triggers.length;var groups=new Array(triggersLength);var eventTypes=new Array(triggersLength);for(var i=0;i<triggersLength;i++){var trigger=triggers[i];groups[i]=pool.getGroup(trigger.trigger);eventTypes[i]=trigger.eventType}this._observer=new GroupObserver(groups,eventTypes);this._buffer=[]}Object.defineProperty(ReactiveSystem.prototype,"subsystem",{get:function(){return this._subsystem},
enumerable:true,configurable:true});ReactiveSystem.prototype.activate=function(){this._observer.activate()};ReactiveSystem.prototype.deactivate=function(){this._observer.deactivate()};ReactiveSystem.prototype.clear=function(){this._observer.clearCollectedEntities()};ReactiveSystem.prototype.execute=function(){var collectedEntities=this._observer.collectedEntities;var ensureComponents=this._ensureComponents;var excludeComponents=this._excludeComponents;var buffer=this._buffer;var j=buffer.length;if(Object.keys(collectedEntities).length!=
0){if(ensureComponents)if(excludeComponents)for(var k in collectedEntities){var e=collectedEntities[k];if(ensureComponents.matches(e)&&!excludeComponents.matches(e))buffer[j++]=e.addRef()}else for(var k in collectedEntities){var e=collectedEntities[k];if(ensureComponents.matches(e))buffer[j++]=e.addRef()}else if(excludeComponents)for(var k in collectedEntities){var e=collectedEntities[k];if(!excludeComponents.matches(e))buffer[j++]=e.addRef()}else for(var k in collectedEntities){var e=collectedEntities[k];
buffer[j++]=e.addRef()}this._observer.clearCollectedEntities();if(buffer.length!=0){this._subsystem.execute(buffer);for(var i=0,bufferCount=buffer.length;i<bufferCount;i++)buffer[i].release();buffer.length=0;if(this._clearAfterExecute)this._observer.clearCollectedEntities()}}};return ReactiveSystem}();entitas.ReactiveSystem=ReactiveSystem})(entitas||(entitas={}));var entitas;
(function(entitas){function as(object,method){return method in object?object:null}var Systems=function(){function Systems(){this._initializeSystems=[];this._executeSystems=[]}Systems.prototype.add=function(system){if("function"===typeof system){var Klass=system;system=new Klass}var reactiveSystem=as(system,"subsystem");var initializeSystem=reactiveSystem!=null?as(reactiveSystem.subsystem,"initialize"):as(system,"initialize");if(initializeSystem!=null){var _initializeSystems=this._initializeSystems;
_initializeSystems[_initializeSystems.length]=initializeSystem}var executeSystem=as(system,"execute");if(executeSystem!=null){var _executeSystems=this._executeSystems;_executeSystems[_executeSystems.length]=executeSystem}return this};Systems.prototype.initialize=function(){for(var i=0,initializeSysCount=this._initializeSystems.length;i<initializeSysCount;i++)this._initializeSystems[i].initialize()};Systems.prototype.execute=function(){var executeSystems=this._executeSystems;for(var i=0,exeSysCount=
executeSystems.length;i<exeSysCount;i++)executeSystems[i].execute()};Systems.prototype.clearReactiveSystems=function(){for(var i=0,exeSysCount=this._executeSystems.length;i<exeSysCount;i++){var reactiveSystem=as(this._executeSystems[i],"subsystem");if(reactiveSystem!=null)reactiveSystem.clear();var nestedSystems=as(this._executeSystems[i],"clearReactiveSystems");if(nestedSystems!=null)nestedSystems.clearReactiveSystems()}};return Systems}();entitas.Systems=Systems})(entitas||(entitas={}));var entitas;
(function(entitas){var viewer;(function(viewer){var PoolObserver=function(){function PoolObserver(_pool){this._pool=_pool;this._groups=this._pool._groups}Object.defineProperty(PoolObserver.prototype,"name",{get:function(){return"Pool"},enumerable:true,configurable:true});Object.defineProperty(PoolObserver.prototype,"Pool",{get:function(){return"Pool "+" ("+this._pool.count+" entities, "+this._pool.reusableEntitiesCount+" reusable, "+Object.keys(this._groups).length+" groups)"},enumerable:true,configurable:true});
Object.defineProperty(PoolObserver.prototype,"entities",{get:function(){return this._pool.count},enumerable:true,configurable:true});Object.defineProperty(PoolObserver.prototype,"reusable",{get:function(){return this._pool.reusableEntitiesCount},enumerable:true,configurable:true});return PoolObserver}();viewer.PoolObserver=PoolObserver})(viewer=entitas.viewer||(entitas.viewer={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var viewer;(function(viewer){var SystemObserver=function(){function SystemObserver(_systems){this._systems=_systems}Object.defineProperty(SystemObserver.prototype,"name",{get:function(){return"Systems"},enumerable:true,configurable:true});Object.defineProperty(SystemObserver.prototype,"Systems",{get:function(){return"Systems "+" ("+this._systems._initializeSystems.length+" init, "+this._systems._executeSystems.length+" exe "},enumerable:true,configurable:true});Object.defineProperty(SystemObserver.prototype,
"initialize",{get:function(){return this._systems._initializeSystems.length},enumerable:true,configurable:true});Object.defineProperty(SystemObserver.prototype,"execute",{get:function(){return this._systems._executeSystems.length},enumerable:true,configurable:true});return SystemObserver}();viewer.SystemObserver=SystemObserver})(viewer=entitas.viewer||(entitas.viewer={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var viewer;(function(viewer){var EntityBehavior=function(){function EntityBehavior(obj){var _this=this;this.obj=obj;if(this.obj.name)this._name=this.obj.name;else this._name="Entity_"+this.obj._creationIndex;Object.defineProperty(this,this._name,{get:function(){return _this.obj.toString()}})}Object.defineProperty(EntityBehavior.prototype,"name",{get:function(){return this._name},enumerable:true,configurable:true});return EntityBehavior}();viewer.EntityBehavior=EntityBehavior})(viewer=
entitas.viewer||(entitas.viewer={}))})(entitas||(entitas={}));var entitas;
(function(entitas){var viewer;(function(viewer){var Systems=entitas.Systems;var EntityBehavior=entitas.viewer.EntityBehavior;var SystemObserver=entitas.viewer.SystemObserver;var PoolObserver=entitas.viewer.PoolObserver;var VisualDebugging=function(){function VisualDebugging(){}VisualDebugging.init=function(pool){if(location.search==="?debug=true"&&window["dat"]){viewer.gui=new dat.GUI({height:5*32-1,width:300});var observer=new PoolObserver(pool);VisualDebugging._controllers={};VisualDebugging._entities=
viewer.gui.addFolder("Entities");VisualDebugging._pools=viewer.gui.addFolder("Pools");VisualDebugging._systems=viewer.gui.addFolder("Systems");VisualDebugging._entities.open();VisualDebugging._pools.open();VisualDebugging._systems.open();VisualDebugging._pools.add(observer,"entities").listen();VisualDebugging._pools.add(observer,"reusable").listen();pool.onEntityCreated.add(function(pool,entity){var proxy=new EntityBehavior(entity);VisualDebugging._controllers[entity.id]=VisualDebugging._entities.add(proxy,
proxy.name).listen()});pool.onEntityDestroyed.add(function(pool,entity){var controller=VisualDebugging._controllers[entity.id];delete VisualDebugging._controllers[entity.id];VisualDebugging._entities.remove(controller)});Systems.prototype.initialize=function(){for(var i=0,initializeSysCount=this._initializeSystems.length;i<initializeSysCount;i++)this._initializeSystems[i].initialize();var sys=new SystemObserver(this);VisualDebugging._systems.add(sys,"initialize").listen();VisualDebugging._systems.add(sys,
"execute").listen()};function get_Systems(){return"Systems "+" ("+this._initializeSystems.length+" init, "+this._executeSystems.length+" exe "}Object.defineProperty(Systems.prototype,"name",{get:function(){return"Systems"}});Object.defineProperty(Systems.prototype,"Systems",{get:get_Systems})}};return VisualDebugging}();viewer.VisualDebugging=VisualDebugging})(viewer=entitas.viewer||(entitas.viewer={}))})(entitas||(entitas={}));
